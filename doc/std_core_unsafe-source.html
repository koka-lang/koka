<!DOCTYPE html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="initial-scale=1.0" />

<style type="text/css">.koka .plaincode, .koka a.pp .pc { display: none; } .koka a.pp { color: inherit; text-decoration: none; }</style>
<link rel="stylesheet" type="text/css" href="styles/koka.css" />

<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Nunito:400,400italic,700,700italic" />
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700,400italic" />

<title>unsafe.kk documentation</title>
</head>

<body class="koka doc body madoko">
<pre class="koka source"><span class="comment">/&#42;---------------------------------------------------------------------------
  Copyright 2023-2024, Microsoft Research, Daan Leijen.

  This is free software; you can redistribute it and/or modify it under the
  terms of the Apache License, Version 2.0. A copy of the License can be
  found in the LICENSE file at the root of this distribution.
---------------------------------------------------------------------------&#42;/</span>

<span class="comment">// Unsafe primitives to dismiss effects.
</span><span class="kw">module</span> <a class="pp" href="std_core_unsafe.html#_null_"><span class="mo">std/core/unsafe</span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>unsafe</span></span></a>

<span class="kw">import</span> <a class="pp" href="std_core_types.html#_null_"><span class="mo">std/core/types</span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>types</span></span></a>

<span class="comment">// &#95;Unsafe&#95;. This function calls a function and pretends it did not have any effect at all.
// Use with utmost care as it should not be used to dismiss user-defined effects that need
// a handler and can cause a segfault at runtime in such cases!
//
// You can use &#96;unsafe-total&#96; to dismiss built-in effects without handlers which include:
//
// - behavioral: &#96;:div&#96; (non-termination/divergence), &#96;:ndet&#96; (non-determinism)
// - state: &#96;:alloc&#96;, &#96;:read&#96;, &#96;:write&#96;, &#96;:st&#96;
// - external: &#96;:ui&#96;, &#96;:fsys&#96;, &#96;:net&#96;, &#96;:blocking&#96;
// - combinations: &#96;:io-total&#96; and &#96;:io-noexn&#96;
//
// Do &#95;not&#95; dismiss &#96;:io&#96; since it has the &#96;:exn&#96; effect that should be handled (and an evidence
// vector should be passed in).
//
// Try to avoid using &#96;unsafe-total&#96; to initialize global values that have a side-effect, but
// use &#96;std/core/delayed/delay&#96; instead:
// &#96;&#96;&#96;
// val myglobal = delay( fn() initialize() )
// fun get-global() : e int
//   myglobal.force
// &#96;&#96;&#96;
</span><span class="decl-fun" id="unsafe_total"><span class="kw">pub</span> <span class="kw">fun</span> <a class="pp" href="std_core_unsafe.html#unsafe_total">unsafe-total<span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>unsafe<span class="fslash last">/</span></span>unsafe<span class="dash">-</span>total: <span class="tp kw">forall</span><span class="tp sp">&lt;</span><span class="tp tv">a</span><span class="tp sp">,</span><span class="tp tv">e</span><span class="tp sp">&gt;</span> <span class="tp sp">(</span><span class="tp tpp">action</span> <span class="tp kw op">:</span> <span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp tv">e</span> <span class="tp tv">a</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp tv">a</span></span></a>( <a class="pp">action<span class="pc">action: <span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp op">$</span><span class="number">60</span> <span class="op">$</span><span class="number">59</span></span></a> <span class="tp kw op">:</span> <span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <a class="pp"><span class="tp tv"><span class="effect">e</span></span><span class="pc">e: <span class="co">E</span></span></a> <a class="pp"><span class="tp tv">a</span><span class="pc">a: <span class="co">V</span></span></a> <a class="pp">)<span class="pc">result: <span class="tp kw op">-></span> <span class="tp">total</span> <span class="number">78</span></span></a> <span class="tp kw op">:</span> <a class="pp" href="std_core_types-source.html#type_space_total"><span class="tp"><span class="effect">a</span></span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>types<span class="fslash last">/</span></span>total: <span class="co">E</span></span></a>
  <a class="pp" href="#unsafe_total_cast">unsafe-total-cast<span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>unsafe<span class="fslash last">/</span></span>unsafe<span class="dash">-</span>total<span class="dash">-</span>cast: <span class="tp sp">(</span><span class="tp tpp">action</span> <span class="tp kw op">:</span> <span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp op">$</span><span class="number">60</span> <span class="op">$</span><span class="number">59</span>) <span class="kw op">-></span> (() <span class="kw op">-></span> <span class="op">$</span><span class="number">59</span>)</span></a>( <a class="pp">action<span class="pc">action: <span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp op">$</span><span class="number">60</span> <span class="op">$</span><span class="number">59</span></span></a> )(</span>)

inline fip <span class="decl-extern" id="unsafe_total_cast"><span class="kw">extern</span> <a class="pp" href="std_core_unsafe.html#unsafe_total_cast">unsafe-total-cast<span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>unsafe<span class="fslash last">/</span></span>unsafe<span class="dash">-</span>total<span class="dash">-</span>cast: <span class="tp kw">forall</span><span class="tp sp">&lt;</span><span class="tp tv">e</span><span class="tp sp">,</span><span class="tp tv">a</span><span class="tp sp">&gt;</span> <span class="tp sp">(</span><span class="tp tpp">action</span> <span class="tp kw op">:</span> <span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp tv">e</span> <span class="tp tv">a</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp sp">(</span><span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp tv">a</span><span class="tp sp">)</span></span></a> <span class="tp kw op">:</span> <span class="tp kw">forall</span><span class="tp sp">&lt;</span><a class="pp"><span class="tp"><span class="effect">e</span></span><span class="pc">e: <span class="co">E</span></span></a><span class="tp sp">,</span><a class="pp"><span class="tp">a</span><span class="pc">a: <span class="co">V</span></span></a><span class="tp sp">&gt;</span> <span class="tp sp">(</span> <span class="tp tpp">action</span> <span class="tp kw op">:</span> <span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <a class="pp"><span class="tp tv"><span class="effect">e</span></span><span class="pc">e: <span class="co">E</span></span></a> <a class="pp"><span class="tp tv">a</span><span class="pc">a: <span class="co">V</span></span></a> <span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp sp">(</span><a class="pp" href="std_core_types-source.html#type_space_total"><span class="tp"><span class="effect">(</span></span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>types<span class="fslash last">/</span></span>total: <span class="co">E</span></span></a><span class="tp sp">)</span> <span class="tp kw op">-></span> <a class="pp" href="std_core_types-source.html#type_space_total"><span class="tp"><span class="effect">a</span></span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>types<span class="fslash last">/</span></span>total: <span class="co">E</span></span></a><span class="tp sp">)</span>
  inline <span class="st">"#1"</span></span>

<span class="comment">// &#95;Unsafe&#95;. This function pretends the given &#96;action&#96; is deterministic
</span><span class="decl-fun" id="pretend_no_ndet"><span class="kw">pub</span> <span class="kw">fun</span> <a class="pp" href="std_core_unsafe.html#pretend_no_ndet">pretend-no-ndet<span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>unsafe<span class="fslash last">/</span></span>pretend<span class="dash">-</span>no<span class="dash">-</span>ndet: <span class="tp kw">forall</span><span class="tp sp">&lt;</span><span class="tp tv">a</span><span class="tp sp">,</span><span class="tp tv">e</span><span class="tp sp">&gt;</span> <span class="tp sp">(</span><span class="tp tpp">action</span> <span class="tp kw op">:</span> <span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp sp">&lt;</span><span class="tp">ndet</span><span class="tp kw op">|</span><span class="tp tv">e</span><span class="tp sp">&gt;</span> <span class="tp tv">a</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp tv">e</span> <span class="tp tv">a</span></span></a>( <a class="pp">action<span class="pc">action: <span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp sp">&lt;</span><span class="tp">ndet</span><span class="tp op">|$</span><span class="number">34</span><span class="op">&gt;</span> <span class="op">$</span><span class="number">33</span></span></a> <span class="tp kw op">:</span> <span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp sp">&lt;</span><a class="pp" href="std_core_types-source.html#type_space_ndet"><span class="tp"><span class="effect">ndet</span></span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>types<span class="fslash last">/</span></span>ndet: <span class="co">X</span></span></a><a class="pp" href="std_core_types-source.html#type_space_effect_extend"><span class="tp">|</span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>types<span class="fslash last">/</span></span>effect<span class="dash">-</span>extend: <span class="tp sp">(</span><span class="co">X</span>, <span class="co">E</span>) <span class="kw op">-></span> <span class="co">E</span></span></a><a class="pp"><span class="tp tv"><span class="effect">e</span></span><span class="pc">e: <span class="co">E</span></span></a><span class="tp sp">&gt;</span> <a class="pp"><span class="tp tv">a</span><span class="pc">a: <span class="co">V</span></span></a> <a class="pp">)<span class="pc">result: <span class="tp kw op">-></span> <span class="number">52</span> <span class="number">51</span></span></a> <span class="tp kw op">:</span> <a class="pp"><span class="tp tv"><span class="effect">e</span></span><span class="pc">e: <span class="co">E</span></span></a> <a class="pp"><span class="tp tv">a</span><span class="pc">a: <span class="co">V</span></span></a>
  <a class="pp" href="#unsafe_total_cast">unsafe-total-cast<span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>unsafe<span class="fslash last">/</span></span>unsafe<span class="dash">-</span>total<span class="dash">-</span>cast: <span class="tp sp">(</span><span class="tp tpp">action</span> <span class="tp kw op">:</span> <span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp sp">&lt;</span><span class="tp">ndet</span><span class="tp op">|$</span><span class="number">34</span><span class="op">&gt;</span> <span class="op">$</span><span class="number">33</span>) <span class="kw op">-></span> <span class="op">$</span><span class="number">34</span> (() <span class="kw op">-></span> <span class="op">$</span><span class="number">33</span>)</span></a>( <a class="pp">action<span class="pc">action: <span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp sp">&lt;</span><span class="tp">ndet</span><span class="tp op">|$</span><span class="number">34</span><span class="op">&gt;</span> <span class="op">$</span><span class="number">33</span></span></a> )(</span>)

<span class="comment">// &#95;Unsafe&#95;. This function checks if two objects have the same address in the heap.
// The results may vary on the backend or compiler optimizations but the function pretends to be &#96;:total&#96;.
// Note also that value types always compare unequal since each value will be boxed fresh in the heap
// when calling this function.
</span><span class="decl-extern" id="unsafe_ptr_eq"><span class="kw">pub</span> inline <span class="kw">extern</span> <a class="pp" href="std_core_unsafe.html#unsafe_ptr_eq">unsafe-ptr-eq<span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>unsafe<span class="fslash last">/</span></span>unsafe<span class="dash">-</span>ptr<span class="dash">-</span>eq: <span class="tp kw">forall</span><span class="tp sp">&lt;</span><span class="tp tv">a</span><span class="tp sp">&gt;</span> <span class="tp sp">(</span><span class="tp tpp">x</span> <span class="tp kw op">:</span> <span class="tp tv">a</span><span class="tp sp">,</span> <span class="tp tpp">y</span> <span class="tp kw op">:</span> <span class="tp tv">a</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp">bool</span></span></a>( x <span class="tp kw op">:</span> <a class="pp"><span class="tp tv">a</span><span class="pc">a: <span class="co">V</span></span></a>, y <span class="tp kw op">:</span> <a class="pp"><span class="tp tv">a</span><span class="pc">a: <span class="co">V</span></span></a> ) <span class="tp kw op">:</span> <a class="pp" href="std_core_types-source.html#type_space_bool"><span class="tp">bool</span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>types<span class="fslash last">/</span></span>bool: <span class="co">V</span></span></a>
  c  inline <span class="st">"kk&#95;box&#95;eq(#1,#2)"</span>
  cs inline <span class="st">"Object.ReferenceEquals(#1,#2)"</span>
  js inline <span class="st">"Object.is(#1,#2)"</span></span>

</pre>

</body>
</html>
